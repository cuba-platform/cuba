<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" []>
<!-- This document was created with Syntext Serna Free. --><chapter id="chapter_deployment" lang="ru">
  <title>Развертывание приложений</title>
  <para>В данной главе содержится информация о развертывании приложений в различной конфигурации.</para>
  <para>На диаграмме ниже приведена возможная структура развернутого приложения, созданного на базе платформы. </para>
  <figure>
    <title>Структура CUBA-приложения</title>
    <mediaobject>
      <imageobject>
        <imagedata contentwidth="80%" align="center" fileref="img/DeploymentStructure.png"/>
      </imageobject>
    </mediaobject>
  </figure>
  <para>В приведенном варианте приложение обеспечивает отсутствие единой точки отказа, балансировку нагрузки и подключение различных типов клиентов. Однако в простейшем случае серверная часть приложения может быть развернута на одном компьютере, содержащем, в том числе, и базу данных. </para>
  <section>
    <title>Каталоги приложения</title>
    <para>В данном разделе описываются каталоги файловой системы, используемые различными <link linkend="app_tiers">блоками приложения</link> во время выполнения.</para>
    <section id="conf_dir">
      <title>Конфигурационный каталог</title>
      <para>Каталог конфигурации предназначен для размещения ресурсов, дополняющих и переопределяющих свойства приложения, пользовательский интерфейс  и бизнес-логику после развертывания приложения. Переопределение обеспечивается механизмом загрузки интерфейса инфраструктуры <code>
          <link linkend="resources">Resources</link>
        </code>, который сначала выполняет поиск в конфигурационном каталоге, а потом в CLASSPATH, так что одноименные ресурсы в конфигурационном каталоге имеют приоритет над расположенными в JAR-файлах и каталогах классов.</para>
      <para>Конфигурационный каталог может содержать следующие типы ресурсов:<itemizedlist>
          <listitem>
            <para>Файл <filename>
                <link linkend="app_properties_files">local.app.properties</link>
              </filename>, определяющий параметры развертывания блоков приложения, работающих под управлением веб-сервера</para>
          </listitem>
          <listitem>
            <para>Конфигурационные файлы <filename>
                <link linkend="metadata.xml">metadata.xml</link>
              </filename>, <filename>
                <link linkend="persistence.xml">persistence.xml</link>
              </filename>, <filename>
                <link linkend="remoting-spring.xml">remoting-spring.xml</link>
              </filename>, <filename>
                <link linkend="spring.xml">spring.xml</link>
              </filename>, <filename>
                <link linkend="views.xml">views.xml</link>
              </filename></para>
          </listitem>
          <listitem>
            <para><link linkend="screen_xml">XML-дескрипторы</link> экранов UI</para>
          </listitem>
          <listitem>
            <para><link linkend="screen_controller">Контроллеры</link> экранов UI в виде исходных текстов Java или Groovy</para>
          </listitem>
          <listitem>
            <para>Скрипты или классы Groovy, а также исходные тексты классов Java, используемые приложением через интерфейс <code>
                <link linkend="scripting">Scripting</link>
              </code>.</para>
          </listitem>
        </itemizedlist></para>
      <para>Расположение конфигурационного каталога определяется свойством приложения <property>
          <link linkend="cuba.confDir">cuba.confDir</link>
        </property>. Для блоков Middleware, Web Client и Web Portal  в стандартном варианте развертывания в <application>Tomcat</application> это подкаталог с именем веб-приложения в каталоге <filename>tomcat/conf</filename>.</para>
    </section>
    <section id="work_dir">
      <title>Рабочий каталог</title>
      <para>Рабочий каталог используется приложением для хранения файлов данных и конфигурации.</para>
      <para>Например, подкаталог <filename>filestorage</filename> рабочего каталога по умолчанию используется <link linkend="file_storage">хранилищем загруженных файлов</link>. Кроме того, блок Middleware на старте сохраняет в рабочем каталоге сгенерированные файлы <filename>
          <link linkend="persistence.xml">persistence.xml</link>
        </filename> и <filename>orm.xml</filename>.</para>
      <para>Расположение рабочего каталога определяется свойством приложения <property>
          <link linkend="cuba.dataDir">cuba.dataDir</link>
        </property>. Для блоков Middleware, Web Client и Web Portal  в стандартном варианте развертывания в <application>Tomcat</application> это подкаталог с именем веб-приложения в каталоге <filename>tomcat/work</filename>.</para>
    </section>
    <section id="log_dir">
      <title>Каталог журналов</title>
      <para>В каталоге журналов создаются лог-файлы приложения.</para>
      <para>Состав и настройка файлов журналов определяются конфигурацией фреймворка <application>Apache log4j</application>. Расположение файла конфигурации определяется системным свойством <literal>
          <link linkend="log4j.configuration">log4j.configuration</link>
        </literal>.</para>
      <para>Данный каталог может быть также использован для сохранения произвольной информации о выполнении приложения. Путь к каталогу журналов определяется свойством приложения <property>
          <link linkend="cuba.logDir">cuba.logDir</link>
        </property>. Для блоков Middleware, Web Client и Web Portal  в стандартном варианте развертывания в <application>Tomcat</application> это каталог <filename>tomcat/logs</filename>.</para>
    </section>
    <section id="temp_dir">
      <title>Временный каталог</title>
      <para>Данный каталог может быть использован для создания произвольных временных файлов во время  выполнения приложения. Путь к временному каталогу определяется свойством приложения <property>
          <link linkend="cuba.tempDir">cuba.tempDir</link>
        </property>. Для блоков Middleware, Web Client и Web Portal  в стандартном варианте развертывания в <application>Tomcat</application> это подкаталог с именем веб-приложения в каталоге <filename>tomcat/temp</filename>.</para>
    </section>
    <section id="db_dir">
      <title>Каталог скриптов базы данных</title>
      <para>В данном каталоге развернутого блока Middleware хранится набор SQL скриптов создания и обновления БД.</para>
      <para>Структура каталога скриптов повторяет описанную в <xref linkend="db_scripts"/>, но имеет один дополнительный верхний уровень, разделяющий скрипты используемых <link linkend="base_projects">базовых проектов</link> и самого приложения. Нумерация каталогов верхнего уровня определяется во время сборки проекта.</para>
      <para>Расположение рабочего каталога определяется свойством приложения <property>
          <link linkend="cuba.dbDir">cuba.dbDir</link>
        </property>. В стандартном варианте развертывания в <application>Tomcat</application> это подкаталог <filename>WEB-INF/db</filename>  каталога веб-приложения среднего слоя, например, <filename>tomcat/webapps/app-core/WEB-INF/db</filename>.</para>
    </section>
  </section>
  <section>
    <title>Использование инструментов JMX</title>
    <para>В данном разделе рассмотрены различные аспекты использования инструментов <application>Java Management Extensions</application>  в CUBA-приложениях.</para>
    <section>
      <title>Встроенная JMX консоль</title>
      <para>Модуль Web Client базового проекта <structname>cuba</structname> платформы содержит средство просмотра и редактирования JMX объектов. Точкой входа в этот инструмент является экран <filename>com/haulmont/cuba/web/app/ui/jmxcontrol/browse/display-mbeans.xml</filename>, зарегистрированный под идентификатором <code>jmxcontrol$DisplayMbeans</code> и в стандартном меню доступный через пункт <guimenu>Администрирование</guimenu> -&gt; <guimenuitem>Консоль JMX</guimenuitem>.</para>
      <para>Без дополнительной настройки консоль отображает все JMX объекты, зарегистрированные в JVM, на которой работает блок Web Client, к которому в данный момент подключен пользователь. Соответственно, в простейшем случае развертывания всех блоков приложения в одном экземпляре веб-контейнера консоль имеет доступ к JMX бинам всех уровней, а также к JMX объектам самой JVM и веб-контейнера. </para>
      <para>Имена бинов приложения имеют префикс, соответствующий имени веб-приложения, их содержащего. Например, бин <code>app-core.cuba:type=CachingFacade</code> загружен веб-приложением <structname>app-core</structname>, реализующим блок Middleware, а бин <code>app.cuba:type=CachingFacade</code> загружен веб-приложением <structname>app</structname>, реализующим блок Web Client.</para>
      <para>Консоль JMX может также работать с JMX объектами произвольной удаленной JVM. Это актуально в случае развертывания блоков приложения на нескольких экземплярах веб-контейнера, например, отдельно Web Client и Middleware. </para>
      <para>Для подключения к удаленной JVM необходимо в поле <guilabel>Соединение JMX</guilabel>  консоли выбрать созданное ранее соединение, либо вызвать экран создания нового соединения:</para>
      <figure>
        <title>Редактирование JMX соединения</title>
        <mediaobject>
          <imageobject>
            <imagedata contentwidth="100%" align="center" fileref="img/jmx-connection-edit.png"/>
          </imageobject>
        </mediaobject>
      </figure>
      <para>Для соединения указывается JMX хост и порт, логин и пароль. Имеется также поле <guilabel>Имя узла</guilabel>, которое заполняется автоматически, если по указанному адресу обнаружен какой-либо блок CUBA-приложения. В этом случае значением этого поля становится комбинация свойств <property>
          <link linkend="cuba.webHostName">cuba.webHostName</link>
        </property> и <property>
          <link linkend="cuba.webPort">cuba.webPort</link>
        </property> данного блока, что позволяет идентифицировать содержащий его сервер. Если подключение произведено к постороннему JMX интерфейсу, то поле <guilabel>Имя узла</guilabel> будет иметь значение  &quot;Unknown JMX interface&quot;. Значение данного поля можно произвольно изменять. </para>
      <para>Для подключения удаленной JVM она должна быть соответствующим образом настроена - см. ниже.</para>
    </section>
    <section>
      <title>Настройка удаленного доступа к JMX</title>
      <para>В данном разделе рассматривается настройка запуска сервера <application>Tomcat</application>, необходимая  для удаленного подключения к нему инструментов JMX.</para>
      <section>
        <title>Tomcat JMX под Windows</title>
        <itemizedlist>
          <listitem>
            <para>Отредактировать файл <filename>bin/setenv.bat</filename> следующим образом:<programlisting>set CATALINA_OPTS=%CATALINA_OPTS% ^
-Dcom.sun.management.jmxremote ^
-Djava.rmi.server.hostname=192.168.10.10 ^
-Dcom.sun.management.jmxremote.ssl=false ^
-Dcom.sun.management.jmxremote.port=7777 ^
-Dcom.sun.management.jmxremote.authenticate=true ^
-Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password ^
-Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access</programlisting></para>
            <para>Здесь в параметре <code>java.rmi.server.hostname</code> необходимо указать реальный IP адрес или DNS имя компьютера, на котором запущен сервер, в параметре <code>com.sun.management.jmxremote.port</code> - порт для подключения инструментов JMX.</para>
          </listitem>
          <listitem>
            <para>Отредактировать файл <filename>conf/jmxremote.access</filename>. Он должен содержать имена пользователей, которые будут подключаться к JMX, и их уровень доступа. Например:<programlisting>admin readwrite</programlisting></para>
          </listitem>
          <listitem>
            <para>Отредактировать файл <filename>conf/jmxremote.password</filename>. Он должен содержать пароли пользователей JMX, например:<programlisting>admin admin</programlisting></para>
          </listitem>
          <listitem>
            <para>Файл паролей должен иметь разрешение на чтение только для пользователя, от имени которого работает сервер <application>Tomcat</application>. Настроить права можно следующим образом:<itemizedlist>
                <listitem>
                  <para>Открыть командную строку и перейти в каталог <filename>conf</filename>.</para>
                </listitem>
                <listitem>
                  <para>Выполнить команду:</para>
                  <para><prompt>cacls jmxremote.password /P &quot;domain_name\user_name&quot;:R</prompt>

</para>
                  <para>где <code>domain_name\user_name</code> - домен и имя пользователя.</para>
                </listitem>
                <listitem>
                  <para>После выполнения данной команды  файл в <application>Проводнике</application> будет отмечен изображением замка.</para>
                </listitem>
              </itemizedlist></para>
          </listitem>
          <listitem>
            <para>Если <application>Tomcat</application> установлен как служба Windows, то для службы должен быть задан вход в систему с учетной записью, имеющей права на файл <filename>jmxremote.password</filename>. Кроме того, следует иметь в виду, что в этом случае файл <filename>bin/setenv.bat</filename> не используется, и соответствующие параметры запуска JVM должны быть заданы в приложении, настраивающем службу.</para>
          </listitem>
        </itemizedlist>
      </section>
      <section>
        <title>Tomcat JMX под Linux</title>
        <para><itemizedlist>
            <listitem>
              <para>Отредактировать файл <filename>bin/setenv.sh</filename> следующим образом:<programlisting>CATALINA_OPTS=&quot;$CATALINA_OPTS -Dcom.sun.management.jmxremote \
-Djava.rmi.server.hostname=192.168.10.10 \
-Dcom.sun.management.jmxremote.port=7777 \
-Dcom.sun.management.jmxremote.ssl=false \
-Dcom.sun.management.jmxremote.authenticate=true&quot;

CATALINA_OPTS=&quot;$CATALINA_OPTS -Dcom.sun.management.jmxremote.password.file=../conf/jmxremote.password -Dcom.sun.management.jmxremote.access.file=../conf/jmxremote.access&quot;</programlisting></para>
              <para>Здесь в параметре <code>java.rmi.server.hostname</code> необходимо указать реальный IP адрес или DNS имя компьютера, на котором запущен сервер, в параметре <code>com.sun.management.jmxremote.port</code> - порт для подключения инструментов JMX.</para>
            </listitem>
            <listitem>
              <para>Отредактировать файл <filename>conf/jmxremote.access</filename>. Он должен содержать имена пользователей, которые будут подключаться к JMX, и их уровень доступа. Например:<programlisting>admin readwrite</programlisting></para>
            </listitem>
            <listitem>
              <para>Отредактировать файл <filename>conf/jmxremote.password</filename>. Он должен содержать пароли пользователей JMX, например:<programlisting>admin admin</programlisting></para>
            </listitem>
            <listitem>
              <para>Файл паролей должен иметь разрешение на чтение только для пользователя, от имени которого работает сервер <application>Tomcat</application>. Настроить права для текущего пользователя можно следующим образом:<itemizedlist>
                  <listitem>
                    <para>Открыть командную строку и перейти в каталог <filename>conf</filename>.</para>
                  </listitem>
                  <listitem>
                    <para>Выполнить команду:</para>
                    <para><prompt>chmod go-rwx jmxremote.password</prompt>

</para>
                  </listitem>
                </itemizedlist></para>
            </listitem>
          </itemizedlist></para>
      </section>
    </section>
  </section>
  <section>
    <title>Отказоустойчивость и балансировка нагрузки</title>
    <para>В данном разделе рассмотрены различные аспекты обеспечения отказоустойчивости и балансировки нагрузки  в CUBA-приложениях.</para>
    <section id="serverId">
      <title>Server Id</title>
      <para><firstterm>Server Id</firstterm> служит для надежной идентификации серверов в кластере Middleware. Идентификатор имеет вид <literal>host:port/context</literal>, например:<programlisting>tezis.haulmont.com:80/app-core</programlisting><programlisting>192.168.44.55:8080/app-core</programlisting></para>
      <para>Идентификатор формируется на основе  параметров конфигурации <link linkend="cuba.webHostName">
          <property>cuba.webHostName</property>
        </link>, <link linkend="cuba.webPort">
          <property>cuba.webPort</property>
        </link>, <link linkend="cuba.webContextName">
          <property>cuba.webContextName</property>
        </link>, поэтому крайне важно корректно указать эти параметры для блока Middleware, работающего в кластере. </para>
      <para>Server Id может быть получен  c помощью бина <code>ServerInfoAPI</code> или через JMX-интерфейс <code>
          <link linkend="serverInfoMBean">ServerInfoMBean</link>
        </code>.</para>
    </section>
  </section>
</chapter>
